---
description: "Admin 전용 규칙 - 글로벌 지식 관리, 권한 제어, API"
---

## Admin (Global Knowledge Management)

### 개요
관리자는 글로벌 지식(Global AI Knowledge)을 생성/삭제할 수 있습니다. 글로벌 지식은 모든 사용자/캔버스가 공통으로 참고하는 전역 지식 베이스이며, AI 채팅의 RAG 컨텍스트에도 자동 포함됩니다.

### 접근 제어
* `profiles.role`: `'admin' | 'user'` (기본값 `'user'`)
* `getUserProfileRole(userId)`: 사용자 시스템 역할 조회 서비스
* `withAdmin(handler)`: 관리자 전용 API 라우트 보호 HOF
* `app/admin/page.tsx`: 서버에서 역할 확인 후 admin만 접근 허용(아니면 `/dashboard`로 리디렉션)

### 데이터 모델
* `global_ai_knowledge`:
  - 컬럼: `id`, `title`, `content`, `tags[]`, `source_url`, `version`, `created_at`
  - 인덱스: `created_at`, `title`, `tags(GIN)`
* `global_knowledge_chunks`:
  - 컬럼: `id`, `knowledge_id(FK)`, `seq`, `text`, `tokens`, `embedding(vector)`, `chunk_hash`, `metadata`, `created_at`
  - 인덱스: `knowledge_id`, `knowledge_id+seq(UNIQUE)`, `chunk_hash`, `embedding(ivfflat)`
* RPC: `match_global_knowledge_chunks(query_embedding, match_count, min_similarity)`

### 라우터 (Admin 전용)
* `GET /api/admin/global-knowledge`: 전역 지식 목록 조회
* `POST /api/admin/global-knowledge`: 전역 지식 생성(본문 청킹/임베딩 저장)
* `POST /api/admin/global-knowledge/upload-pdf`: PDF 업로드 전용 엔드포인트
* `DELETE /api/admin/global-knowledge/[id]`: 전역 지식 단일 삭제

### 서비스
* `services/storageService.ts` (통합됨):
  - `createGlobalKnowledge({ title, content, tags, sourceUrl })`: 문서 생성 후 자동 청킹/임베딩
  - `listGlobalKnowledge()`: 목록 조회
  - `deleteGlobalKnowledge(id)`: 문서 삭제
  - `createGlobalKnowledgeChunks({ knowledgeId, content })`: 텍스트 청킹 → 배치 임베딩 → 청크 저장
* `services/pdf.ts`: PDF 텍스트 추출 공용 유틸리티 (`extractPdfText`)

### Admin UI
* `app/admin/client.tsx`:
  - "AI 지식" 탭에 업로드 버튼 4열(PDF/YouTube/URL/Text)
  - 글로벌 지식 리스트(삭제 지원)
  - 업로드 모달은 기존 `UploadModal` 재사용(`isGlobalKnowledge` 플래그)
  - `handleUploadComplete`: 모달에서 이미 생성 완료되므로 캐시 갱신만 수행 (중복 방지)
  - "AIChat 프롬프트" 탭에 온보딩 프롬프트 편집 섹션 추가
    - 현재 저장된 `ONBOARDING_SYSTEM_PROMPT` 내용을 그대로 로드하여 Textarea로 편집만 가능
    - 저장 시 존재하면 `PATCH /api/admin/rag-prompts/:id`, 없으면 `POST /api/admin/rag-prompts`
    - 편집 내용은 온보딩 API에 즉시 반영됨 (서버는 Admin 저장값 우선 사용)
* `components/Admin/UploadButtons.tsx`: 업로드 버튼 그리드
* `components/Admin/KnowledgeList.tsx`: 리스트 뷰(삭제 버튼 호버 노출)

### AI 채팅 통합
* `CanvasRAGService.buildContext()`에서 전역 지식 컨텍스트를 함께 결합
  - `composeGlobalKnowledgeContext()`: 질문 임베딩 → `global_knowledge_chunks` 매칭 → 상위 청크 + 제목으로 구성
* 순서: 캔버스 지식 → 글로벌 지식 → 웹 검색

### 온보딩 프롬프트 관리(Onboarding Prompt)
* 데이터 소스 우선순위: Admin 저장값(`rag_prompts.name = 'ONBOARDING_SYSTEM_PROMPT'`) → 코드 상수 `DEFAULT_ONBOARDING_SYSTEM_PROMPT`
* 서버 사용처: `app/api/canvases/[canvasId]/onboarding/route.ts`
  - `ragPromptService.getInstructionByName('ONBOARDING_SYSTEM_PROMPT')`로 조회 후 폴백 사용
* Admin UI 사용처: `app/admin/client.tsx`
  - Textarea로 현재 프롬프트 편집만 제공(신규 템플릿 선택/교체 없이)
  - 저장 시 캐시 무효화 후 목록 갱신
* 주의: 마크다운은 모델 입력으로 그대로 전달되며, 온보딩 대화 응답은 plain text로 안내됩니다.

