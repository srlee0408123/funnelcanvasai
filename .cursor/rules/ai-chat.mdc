---
description: "AI 채팅 시스템 개발 시 참고하세요 - RAG 기반 컨텍스트 생성, 채팅 히스토리, 실시간 메시징 기능"
---

## 6. AI 채팅 (AI Chat)

### 라우터
* `POST /api/chat/canvas`: 사용자 메시지를 받아 캔버스 지식 기반 RAG를 수행하고 AI 답변을 스트리밍으로 반환합니다.
* `GET /api/canvases/[canvasId]/chat-messages`: 특정 캔버스의 채팅 기록을 시간순으로 조회합니다.
* `POST /api/canvases/[canvasId]/chat-messages`: 새 채팅 메시지(사용자/AI)를 저장합니다.

### 스키마 (Drizzle ORM)
* `chatMessages`: 캔버스별 채팅 메시지를 저장하며 `canvasId`, `userId`, `role`('user' | 'assistant'), `content`, `createdAt` 필드를 포함합니다.

### 서비스 함수/훅
* `SidebarChat (Component)`: 채팅 UI를 렌더링하고, 메시지 전송, 실시간 수신, 스크롤 관리를 처리합니다.
* `CanvasRAGService (Service)`: 사용자 질문에 대해 캔버스 지식을 벡터 검색하고 웹 검색을 결합하여 컨텍스트를 구성합니다.
* `OpenAIService (Service)`: OpenAI API를 호출하여 임베딩 생성 및 GPT 모델을 통한 챗 응답을 담당합니다.
* `buildSystemPrompt (Service)`: AI의 역할("Canvas AI" 마케팅 전문가)과 캔버스 컨텍스트를 정의하는 시스템 프롬프트를 동적으로 생성합니다.
* `formatChatHistory (Service)`: 채팅 히스토리를 OpenAI API 형식에 맞게 포맷팅합니다.
* `WebSearchService`: Perplexity API를 통한 실시간 웹 검색 결과를 AI 컨텍스트에 포함합니다.

### 핵심 특징
* **RAG 기반 답변**: 캔버스 내 지식 자료, 노드, 메모, 할일을 종합하여 맥락에 맞는 답변을 제공합니다.
* **실시간 스트리밍**: OpenAI의 스트리밍 API를 활용하여 사용자에게 실시간으로 응답을 전달합니다.
* **마케팅 전문가 페르소나**: "Canvas AI"라는 마케팅 전문가 캐릭터로 일관된 톤앤매너를 유지합니다.
* **웹 검색 통합**: 최신 정보가 필요한 경우 웹 검색 결과를 자동으로 포함하여 답변의 정확성을 높입니다.