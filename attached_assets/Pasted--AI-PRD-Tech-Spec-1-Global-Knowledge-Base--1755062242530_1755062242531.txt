ğŸ“Œ ë‘ë”ì§€ AI â€” í¼ë„ ìº”ë²„ìŠ¤ PRD & Tech Spec (ìµœì¢…)

1. ê¸°ë³¸ ì§€ì‹ë² ì´ìŠ¤ (Global Knowledge Base)

ì—­í• : ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ê³µí†µ ì œê³µë˜ëŠ” ì„¸ì¼ì¦ˆÂ·í¼ë„ ì„¤ê³„ ì „ë¬¸ ì§€ì‹ ì €ì¥ì†Œ

DB í…Œì´ë¸”: global_ai_knowledge

id: ê³ ìœ  ID

title: ìë£Œ ì œëª©

content: ì „ì²˜ë¦¬Â·ë²¡í„°í™”ëœ í…ìŠ¤íŠ¸

tags: ì˜ˆ) "ì„¸ì¼ì¦ˆ ì›ì¹™", "í¼ë„ ì „ëµ"

source_url: ì°¸ê³  ë§í¬(ì„ íƒ)

version: ë²„ì „ ê´€ë¦¬

ì—…ë¡œë“œ ê¶Œí•œ: ê´€ë¦¬ì ì „ìš© (ëŒ€ì‹œë³´ë“œ ì—…ë¡œë“œ)

í™œìš© ì‹œì : AI í”¼ë“œë°±, í…œí”Œë¦¿ ìƒì„±, ë…¸ë“œ ì¶”ì²œ ì‹œ í•­ìƒ ì°¸ì¡°

2. ê°œë³„ ì§€ì‹ë² ì´ìŠ¤ (User Knowledge Base)

ì—­í• : í¬ë¦¬ì—ì´í„°ë³„ ì—…ë¡œë“œ ìë£Œ ì €ì¥ì†Œ

DB í…Œì´ë¸”: user_ai_knowledge

id, user_id, asset_type(pdf/url/video/text), asset_title, asset_content, tags, source_url, created_at

ì—…ë¡œë“œ ê²½ë¡œ: ì¢Œì¸¡ ì‚¬ì´ë“œë°” â†’ "ì§€ì‹ ì—…ë¡œë“œ"

í™œìš© ì‹œì : í•´ë‹¹ ì‚¬ìš©ì í¼ë„ ì„¤ê³„/AI í”¼ë“œë°± ì‹œ Global KBì™€ í•¨ê»˜ ì»¨í…ìŠ¤íŠ¸ë¡œ í†µí•©

PDF ì²˜ë¦¬: í…ìŠ¤íŠ¸ PDF vs ìŠ¤ìº” PDF ìë™ ê°ì§€ â†’ ìŠ¤ìº” PDFëŠ” OpenAI API OCR ì²˜ë¦¬

3. í¼ë„ ìº”ë²„ìŠ¤ êµ¬ì¡°

ì¢Œì¸¡ ì‚¬ì´ë“œë°”: ìë£Œ ì—…ë¡œë“œ, ì—…ë¡œë“œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸, í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°

ì¤‘ì•™ í™”ì´íŠ¸ë³´ë“œ: í”¼ê·¸ë§ˆ/ë©”ì´í¬ë‹·ì»´ ìŠ¤íƒ€ì¼ ë“œë˜ê·¸ì•¤ë“œë¡­ UI

ë…¸ë“œ(ì•„ì´ì½˜): ì´ë©”ì¼, ë¬¸ì CRM, ëœë”©í˜ì´ì§€ ë“± + í•˜ìœ„ ê°œë…(ì†ì„±Â·ì½˜í…ì¸ Â·ì§€í‘œ) ì„¤ì • ê°€ëŠ¥

ìš°ì¸¡ íŒ¨ë„: ë…¸ë“œ ì„ íƒ ì‹œ 3ê°œ íƒ­ í‘œì‹œ

ì†ì„±(Properties): ì±„ë„, CTA, ì„¤ì • ê°’

ì½˜í…ì¸ (Contents): ì´ë©”ì¼ ì œëª©/ë³¸ë¬¸, VSL ìŠ¤í¬ë¦½íŠ¸ ë“±

ì§€í‘œ(Metrics): CTR, ì˜¤í”ˆìœ¨, í´ë¦­ ìˆ˜, ë°œì†¡ëŸ‰ (ê¸°ê°„ í•„í„°)

4. AI í”¼ë“œë°± ë¡œì§

íŠ¸ë¦¬ê±°: ìš°ì¸¡ í•˜ë‹¨ í”Œë¡œíŒ… ë²„íŠ¼ ë˜ëŠ” Cmd/Ctrl + /

ì„œë²„ ì²˜ë¦¬:

í˜„ì¬ í¼ë„ flow_json

Global KB Top-K ë¬¸ì„œ

User KB Top-K ë¬¸ì„œ

OpenAI API í˜¸ì¶œ â†’ JSON ì‘ë‹µ:

[
  {
    "nodeId": "string",
    "suggestion": "string",
    "severity": "low|medium|high",
    "rationale": "string"
  }
]

UI ë°˜ì˜: ë…¸ë“œë³„ ë±ƒì§€Â·íˆ´íŒ í‘œì‹œ

5. í…œí”Œë¦¿ ì‹œìŠ¤í…œ

êµ¬ì„±: ì‚¬ì „ ì œì‘ í…œí”Œë¦¿ì„ Global DBì— ì €ì¥, ëˆ„êµ¬ë‚˜ importÂ·ìˆ˜ì • ê°€ëŠ¥

DB í…Œì´ë¸”: funnel_templates

id, title, description, flow_json, tags, created_by, is_global

ì‚¬ìš© íë¦„: í…œí”Œë¦¿ ì„ íƒ â†’ í˜„ì¬ ë³´ë“œì— import â†’ í•„ìš” ì‹œ ìˆ˜ì • í›„ ì €ì¥

6. ê´€ë¦¬ ì „ëµ

Global KB: ìµœì‹  ì„¸ì¼ì¦ˆ/í¼ë„ ì „ëµ, ë§ˆì¼€íŒ… ì§€í‘œ ê¸°ì¤€ ì •ê¸° ì—…ë°ì´íŠ¸

User KB: ì—…ë¡œë“œ ì‹œ ìë™ ì „ì²˜ë¦¬Â·íƒœê·¸í™”

AI í’ˆì§ˆ ìœ ì§€: ë²„ì „Â·íƒœê·¸ ê¸°ë°˜ ê²€ìƒ‰, ì¤‘ë³µ ë¬¸ì„œ ê´€ë¦¬

ì´ êµ¬ì¡°ë¡œ ê°€ë©´ **ì „ë¬¸ê°€ ì§€ì‹(ê¸°ë³¸)**ê³¼ ì‚¬ìš©ì ë§ì¶¤ ì§€ì‹ì„ ì™„ì „íˆ ë¶„ë¦¬Â·í†µí•© ì ìš© ê°€ëŠ¥í•˜ë©°, í…œí”Œë¦¿ê³¼ ë…¸ë“œ í™•ì¥ì„±ê¹Œì§€ í™•ë³´ë©ë‹ˆë‹¤.



ğŸš€ Replit Handoff â€” ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸ & ì‚¬ì–‘

ì´ ì ˆì„ ê·¸ëŒ€ë¡œ Replit ê°œë°œ/ë°°í¬ì— ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. (Node/Next.js + Postgres ê°€ì •)

A. ëŸ°íƒ€ì„ & ì˜ì¡´ì„±

Node 20+, PostgreSQL 14+

NPM: express ë˜ëŠ” next, pg, passport, passport-google-oauth20, multer, pdf-parse, sharp, openai, zod, p-limit, uuid

ì„ íƒ: react-flow-renderer, dagre, pgvector(í™•ì¥), bullmq(ì˜µì…˜)

B. ENV (Replit Secrets)

APP_ENV=dev|prod
APP_URL=https://<your-repl>.repl.co
DATABASE_URL=postgres://...
SESSION_SECRET=...
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
OAUTH_REDIRECT_URI=https://<your-repl>.repl.co/auth/google/callback
OPENAI_API_KEY=sk-...
APIFY_TOKEN=...
INTERNAL_TOKEN=<long_random>
TZ_DEFAULT=Asia/Seoul

C. ë¼ìš°íŒ…(API í•µì‹¬)

Auth

GET /auth/google â†’ OAuth ì‹œì‘

GET /auth/google/callback â†’ ë¡œê·¸ì¸ í›„ /app

Assets/KB

POST /api/assets (íŒŒì¼/URL ë“±ë¡: pdf|youtube|instagram|note)

GET /api/assets/:id/status

Canvas

GET /api/canvas/:id/state/latest

POST /api/canvas/:id/state { flow_json }

Feedback

POST /api/canvas/:id/feedback { state_version } â†’ ìºì‹œ(flow_hash/kb_hash) ê²€ì‚¬ í›„ OpenAI í˜¸ì¶œ

GET /api/canvas/:id/feedback/latest

Templates

GET /api/templates?scope=public|shared|private

POST /api/templates/apply { template_id, canvas_id, parameters }

(ê´€ë¦¬) POST /api/templates / POST /api/templates/:id/versions

Node I/O

POST /api/node/:instanceId/properties { props_json }

POST /api/node/:instanceId/contents { content_type, content_text }

POST /api/node/:instanceId/metrics { metric_key, value, period_start, period_end, source }

ëª¨ë“  /apiëŠ” ì„¸ì…˜ ì¸ì¦ + ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê¶Œí•œ ê°€ë“œ, /internal/*ëŠ” Authorization: Bearer INTERNAL_TOKEN í•„ìˆ˜.

D. ìŠ¤ì¼€ì¤„ëŸ¬/ì¡(HTTP í˜¸ì¶œ)

5ë¶„ë§ˆë‹¤: POST /internal/jobs/tick â€” ì¸ì œìŠ¤íŠ¸ í ì‹¤í–‰/ì¬ì‹œë„

ë¬¸ì„œìš”ì•½ ìºì‹œ ì¬ìƒì„±(ì„ íƒ): POST /internal/kb/refresh â€” ë³€ê²½ë¶„ë§Œ

E. PDF/URL ì¸ì œìŠ¤íŠ¸ íŒŒì´í”„ë¼ì¸ (ìš”ì•½ êµ¬í˜„)

ë“±ë¡(íŒŒì¼/URL) â†’ assets ìƒì„± â†’ ingest_jobs enqueue

PDF: pdf-parse 1ì°¨ ì¶”ì¶œ â†’ í˜ì´ì§€ë³„ ìŠ¤ìº” íŒì • â†’ ìŠ¤ìº” í˜ì´ì§€ëŠ” sharpë¡œ 300DPI ì´ë¯¸ì§€ ë³€í™˜ â†’ OpenAI Vision OCR â†’ ë³‘í•© í…ìŠ¤íŠ¸

URL: Apify ìˆ˜ì§‘(ìº¡ì…˜/ì„¤ëª…/ë©”íƒ€) â†’ ì „ì²˜ë¦¬

ì²­í¬(800~1200ì) & ì„ë² ë”©(OpenAI) â†’ asset_chunks ì €ì¥ (pgvector)

ë¬¸ì„œìš”ì•½ ìºì‹œ ìƒì„± ë° ì €ì¥

F. ìºì‹œ í‚¤

flow_hash = sha256(normalized(flow_json))

kb_hash = sha256(sorted(topk_asset_ids))

ë™ì¼ ì¡°í•©ì´ë©´ ì§ì „ í”¼ë“œë°± ì‘ë‹µ ì¬ì‚¬ìš©(TTL ì˜µì…˜)

G. í”„ë¡¬í”„íŠ¸ êµ¬ì„±(í”¼ë“œë°±)

ê³ ì • íŒŒíŠ¸: ë² ìŠ¤íŠ¸í”„ë™í‹°ìŠ¤(ë²„ì „: bp_version) + ì—­í• ì§€ì‹œ(ì„¸ì¼ì¦ˆ/í¼ë„ ì „ë¬¸ê°€)

ì…ë ¥ íŒŒíŠ¸: flow_json(ê°„ì†Œí™”), ê´€ë ¨ ìì‚° ìš”ì•½ Topâ€‘K, ì‚¬ìš©ì ì—…ì¢…/ëª©í‘œ

ì¶œë ¥ ìŠ¤í‚¤ë§ˆ(JSON): [ { nodeId, suggestion, severity, rationale } ]

ğŸ—„ DB â€” í•µì‹¬ í…Œì´ë¸” DDL (Postgres, ìš”ì•½)

ì‹¤ì œ ë°°í¬ ì „ uuid-ossp, pgvector í™•ì¥ ì„¤ì¹˜ ê³ ë ¤.

-- 0) í™•ì¥ (ì„ íƒ)
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS vector; -- pgvector

-- 1) ê³„ì •/ì›Œí¬ìŠ¤í˜ì´ìŠ¤
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE NOT NULL,
  google_id TEXT UNIQUE,
  name TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
CREATE TABLE workspaces (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  owner_user_id UUID REFERENCES users(id),
  name TEXT,
  plan TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE TABLE workspace_members (
  workspace_id UUID REFERENCES workspaces(id),
  user_id UUID REFERENCES users(id),
  role TEXT CHECK (role IN ('owner','admin','editor','viewer')),
  invited_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (workspace_id, user_id)
);

-- 2) ìº”ë²„ìŠ¤/ìƒíƒœ/í”¼ë“œë°±
CREATE TABLE canvases (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workspace_id UUID REFERENCES workspaces(id),
  title TEXT,
  template_id UUID NULL,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
CREATE TABLE canvas_states (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  canvas_id UUID REFERENCES canvases(id),
  version INT NOT NULL,
  flow_json JSONB NOT NULL,
  flow_hash TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE INDEX ON canvas_states (canvas_id, version DESC);
CREATE INDEX ON canvas_states (flow_hash);

CREATE TABLE feedback_runs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  canvas_id UUID REFERENCES canvases(id),
  state_version INT,
  flow_hash TEXT,
  kb_hash TEXT,
  prompt_version TEXT,
  bp_version TEXT,
  model TEXT,
  latency_ms INT,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE TABLE feedback_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  run_id UUID REFERENCES feedback_runs(id) ON DELETE CASCADE,
  node_id TEXT,
  severity TEXT CHECK (severity IN ('low','medium','high')),
  suggestion TEXT,
  rationale TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 3) ìì‚°/ì¸ì œìŠ¤íŠ¸/ì„ë² ë”©
CREATE TABLE assets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workspace_id UUID REFERENCES workspaces(id),
  canvas_id UUID NULL REFERENCES canvases(id),
  type TEXT CHECK (type IN ('pdf','youtube','instagram','note')),
  url TEXT,
  file_ref TEXT,
  content_sha256 TEXT,
  title TEXT,
  meta_json JSONB,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE UNIQUE INDEX ON assets (content_sha256) WHERE content_sha256 IS NOT NULL;

CREATE TABLE asset_chunks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  asset_id UUID REFERENCES assets(id) ON DELETE CASCADE,
  seq INT,
  text TEXT,
  embedding vector(1536),
  tokens INT,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE INDEX asset_chunks_ivf ON asset_chunks USING ivfflat (embedding vector_cosine_ops);
CREATE INDEX ON asset_chunks (asset_id, seq);

CREATE TABLE ingest_jobs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  asset_id UUID REFERENCES assets(id) ON DELETE CASCADE,
  job_type TEXT CHECK (job_type IN ('apify','pdf_text','pdf_ocr')),
  status TEXT CHECK (status IN ('pending','running','succeeded','failed')),
  attempts INT DEFAULT 0,
  last_error TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- 4) í…œí”Œë¦¿/ë„ì›€ë§/ì•„ì´ì½˜
CREATE TABLE templates (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  owner_scope TEXT CHECK (owner_scope IN ('public','shared','private')),
  owner_workspace_id UUID NULL REFERENCES workspaces(id),
  name TEXT,
  category TEXT,
  tags TEXT[],
  current_version INT,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE TABLE template_versions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  template_id UUID REFERENCES templates(id) ON DELETE CASCADE,
  version INT,
  flow_json JSONB,
  parameters_json JSONB,
  best_practices TEXT[],
  changelog TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE help_docs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  key TEXT UNIQUE,
  title TEXT,
  html TEXT,
  asset_ref TEXT,
  owner_user_id UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ DEFAULT now()
);
CREATE TABLE icon_meta (
  id TEXT PRIMARY KEY,
  label TEXT,
  icon_name TEXT,
  color TEXT,
  info_doc_key TEXT REFERENCES help_docs(key),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 5) ë…¸ë“œ íƒ€ì…/ì¸ìŠ¤í„´ìŠ¤/ì½˜í…ì¸ /ì§€í‘œ
CREATE TABLE node_types (
  key TEXT PRIMARY KEY,
  label TEXT,
  category TEXT,
  default_props_json JSONB
);
CREATE TABLE node_instances (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  canvas_state_id UUID REFERENCES canvas_states(id) ON DELETE CASCADE,
  node_id_in_flow TEXT,
  node_type_key TEXT REFERENCES node_types(key),
  props_json JSONB,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE TABLE node_contents (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  node_instance_id UUID REFERENCES node_instances(id) ON DELETE CASCADE,
  content_type TEXT,
  content_text TEXT,
  version INT DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE TABLE node_metrics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  node_instance_id UUID REFERENCES node_instances(id) ON DELETE CASCADE,
  metric_key TEXT,
  metric_value_numeric DOUBLE PRECISION,
  metric_value_text TEXT,
  period_start TIMESTAMPTZ,
  period_end TIMESTAMPTZ,
  source TEXT CHECK (source IN ('auto','manual')),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 6) KB â€” Global & User
CREATE TABLE global_ai_knowledge (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title TEXT,
  content TEXT,
  tags TEXT[],
  source_url TEXT,
  version INT,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE TABLE user_ai_knowledge (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  asset_type TEXT,
  asset_title TEXT,
  asset_content TEXT,
  tags TEXT[],
  source_url TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

ì¸ë±ìŠ¤/ì œì•½ì€ ì„œë¹„ìŠ¤ ìš´ì˜ ì¤‘ ì¿¼ë¦¬ íŒ¨í„´ì— ë§ì¶° ì¶”ê°€ ìµœì í™”í•˜ì‹­ì‹œì˜¤.

ğŸ”’ ë³´ì•ˆ/ê¶Œí•œ

ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ëŠ” ì„¸ì…˜ ì¸ì¦ + ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë²”ìœ„ ê²€ì¦

/internal/*ëŠ” í—¤ë” í† í° í•„ìˆ˜ + IP ì œí•œ(ì˜µì…˜)

íŒŒì¼ ì—…ë¡œë“œëŠ” í™•ì¥ì í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ + ì‚¬ì´ì¦ˆ ì œí•œ

URL ì¸ì œìŠ¤íŠ¸ëŠ” ë„ë©”ì¸ ê²€ì¦(í—ˆìš© ëª©ë¡)

ğŸ§ª QA ì²´í¬ (ì¶œì‹œ ì „)



ğŸ§© ì½”ë“œ ìŠ¤ë‹ˆí«(ê°œìš”)

// feedback controller (ì˜ì‚¬ì½”ë“œ)
const runFeedback = async (canvasId, stateVersion, userId) => {
  const state = await getCanvasState(canvasId, stateVersion);
  const flowHash = sha256(normalize(state.flow_json));
  const kb = await getTopKKnowledge(userId, state); // Global+User KB mix
  const kbHash = sha256(kb.ids.join(','));

  const cached = await getCachedFeedback(flowHash, kbHash);
  if (cached) return cached;

  const prompt = buildPrompt({ flow: state.flow_json, kb });
  const result = await openai.responses.create({
    model: 'gpt-4.1-mini',
    input: prompt,
    response_format: { type: 'json' }
  });
  return await saveFeedback(result, { flowHash, kbHash });
};

âœ… í•œ ì¤„ ìš”ì•½

ì´ ë¬¸ì„œì˜ ENVÂ·APIÂ·DDLÂ·ì¡Â·ìºì‹œ ì„¤ì •ë§Œ ë°˜ì˜í•˜ë©´ Replitì—ì„œ ë°”ë¡œ MVP êµ¬ë™ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ìš´ì˜ ì¤‘ ë¹„ìš©/ì§€ì—°ì€ ìºì‹œ + í + ì¤‘ë³µí•´ì‹œë¡œ ê´€ë¦¬í•˜ì‹œê³ , í…œí”Œë¦¿/ë…¸ë“œ/ì§€í‘œëŠ” ìœ„ ìŠ¤í‚¤ë§ˆëŒ€ë¡œ í™•ì¥í•˜ì‹­ì‹œì˜¤.



ğŸŸ¢ Replit Zeroâ€‘IQ Handoff (í•œ ì¤„ì”© ë³µë¶™ ê°€ì´ë“œ)

Replit íŒ€ì´ ê·¸ëƒ¥ ë³µë¶™ë§Œ í•´ë„ ëŒì•„ê°€ê²Œ ë§Œë“  ì´ˆê°„ë‹¨ ì•ˆë‚´ì…ë‹ˆë‹¤. Next.js ì—†ì´ Express + EJSë¡œ ìµœì†Œ ê°€ë™ í›„, ë‚˜ì¤‘ì— React Flowë¥¼ ë¶™ì´ëŠ” ë‹¨ê³„ê¹Œì§€ í¬í•¨í–ˆìŠµë‹ˆë‹¤.

0) ìƒˆ Repl ë§Œë“¤ê¸°

Replitì—ì„œ Node.js í…œí”Œë¦¿ë¡œ ìƒˆ Repl ìƒì„±

ì¢Œì¸¡ Secrets íƒ­ì— ì•„ë˜ ê°’ë“¤ ì¶”ê°€

APP_ENV=dev
APP_URL=https://<your-repl>.repl.co
DATABASE_URL=postgres://user:pass@host:5432/db
SESSION_SECRET=change_me
GOOGLE_CLIENT_ID=<from Google Cloud>
GOOGLE_CLIENT_SECRET=<from Google Cloud>
OAUTH_REDIRECT_URI=https://<your-repl>.repl.co/auth/google/callback
OPENAI_API_KEY=sk-...
APIFY_TOKEN=...
INTERNAL_TOKEN=very_long_random
TZ_DEFAULT=Asia/Seoul

1) ì„¤ì¹˜(í„°ë¯¸ë„ì—ì„œ í•œ ë²ˆë§Œ)

npm i express ejs pg passport passport-google-oauth20 express-session multer pdf-parse sharp openai zod p-limit uuid
npm i -D nodemon

PostgresëŠ” Neon/Supabase ì—°ê²° ë¬¸ìì—´ì„ DATABASE_URLì— ë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤.

2) í”„ë¡œì íŠ¸ êµ¬ì¡° ë§Œë“¤ê¸°

.
â”œâ”€ index.js            # ì„œë²„ ì‹œì‘ íŒŒì¼
â”œâ”€ views/
â”‚  â””â”€ index.ejs        # ë¡œê·¸ì¸/ì•± ì§„ì… í…ŒìŠ¤íŠ¸ìš©
â”œâ”€ routes/
â”‚  â”œâ”€ auth.js
â”‚  â”œâ”€ api.js
â”‚  â””â”€ internal.js
â”œâ”€ lib/
â”‚  â”œâ”€ db.js            # pg pool
â”‚  â”œâ”€ auth.js          # passport ì„¤ì •
â”‚  â”œâ”€ hash.js          # sha256
â”‚  â”œâ”€ openai.js        # OpenAI í´ë¼ì´ì–¸íŠ¸
â”‚  â””â”€ utils.js
â””â”€ sql/
   â””â”€ schema.sql       # ì•„ë˜ DDL ë³µë¶™ í›„ ì‹¤í–‰

3) ìµœì†Œ ì„œë²„(index.js)

const express = require('express');
const session = require('express-session');
const passport = require('passport');
const path = require('path');
require('./lib/auth'); // passport ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°

const app = express();
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));
app.use(express.json({ limit: '2mb' }));
app.use(express.urlencoded({ extended: true }));
app.use(session({ secret: process.env.SESSION_SECRET, resave: false, saveUninitialized: false }));
app.use(passport.initialize());
app.use(passport.session());

app.get('/', (req, res) => res.render('index', { user: req.user }));
app.use('/auth', require('./routes/auth'));
app.use('/api', require('./routes/api'));
app.use('/internal', require('./routes/internal'));
app.get('/healthz', (req, res)=>res.send('ok'));

const port = process.env.PORT || 3000;
app.listen(port, ()=> console.log('server on', port));

4) Passport ì„¤ì •(lib/auth.js)

const passport = require('passport');
const { Strategy: GoogleStrategy } = require('passport-google-oauth20');
const { upsertUser, findUserById } = require('./db');

passport.use(new GoogleStrategy({
  clientID: process.env.GOOGLE_CLIENT_ID,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET,
  callbackURL: process.env.OAUTH_REDIRECT_URI,
}, async (accessToken, refreshToken, profile, done) => {
  try {
    const user = await upsertUser({
      google_id: profile.id,
      email: profile.emails?.[0]?.value,
      name: profile.displayName,
    });
    done(null, user);
  } catch (e) { done(e); }
}));
passport.serializeUser((user, done)=> done(null, user.id));
passport.deserializeUser(async (id, done)=> {
  try { done(null, await findUserById(id)); } catch(e){ done(e); }
});

module.exports = passport;

5) DB ì—°ê²°(lib/db.js)

const { Pool } = require('pg');
const pool = new Pool({ connectionString: process.env.DATABASE_URL });

async function upsertUser({ google_id, email, name }){
  const q = `
    INSERT INTO users (google_id, email, name)
    VALUES ($1,$2,$3)
    ON CONFLICT (email) DO UPDATE SET name = EXCLUDED.name
    RETURNING id, email, name;`;
  const { rows } = await pool.query(q, [google_id, email, name]);
  return rows[0];
}
async function findUserById(id){
  const { rows } = await pool.query('SELECT id,email,name FROM users WHERE id=$1', [id]);
  return rows[0];
}
module.exports = { pool, upsertUser, findUserById };

6) ë¼ìš°íŠ¸: Auth(routes/auth.js)

const router = require('express').Router();
const passport = require('passport');

router.get('/google', passport.authenticate('google', { scope: ['profile','email'] }));
router.get('/google/callback',
  passport.authenticate('google', { failureRedirect: '/' }),
  (req,res)=>res.redirect('/app'));

module.exports = router;

7) ë¼ìš°íŠ¸: API ìµœì†Œ(routes/api.js)

const router = require('express').Router();
function requireAuth(req,res,next){ if(req.isAuthenticated()) return next(); return res.redirect('/'); }

router.get('/me', requireAuth, (req,res)=> res.json({ id:req.user.id, email:req.user.email }));
// ì—¬ê¸°ì— /api/canvas, /api/assets, /api/templates ë“± ë‹¨ê³„ì ìœ¼ë¡œ ì¶”ê°€

module.exports = router;

8) ë¼ìš°íŠ¸: Internal(routes/internal.js)

const router = require('express').Router();
router.use((req,res,next)=>{
  const ok = req.headers.authorization === `Bearer ${process.env.INTERNAL_TOKEN}`;
  if(!ok) return res.status(401).send('unauthorized');
  next();
});
router.post('/jobs/tick', (req,res)=> res.json({ ok:true }));
module.exports = router;

9) ë·°(views/index.ejs)

<!doctype html>
<html>
  <body>
    <% if (!user) { %>
      <a href="/auth/google">Google ë¡œê·¸ì¸</a>
    <% } else { %>
      <p>ë¡œê·¸ì¸: <%= user.email %></p>
      <a href="/api/me">/api/me í…ŒìŠ¤íŠ¸</a>
    <% } %>
  </body>
</html>

10) ìŠ¤í‚¤ë§ˆ ì ìš©(sql/schema.sql)

ìº”ë²„ìŠ¤ ìƒë‹¨ì˜ DDL ë¸”ë¡ ì „ì²´ë¥¼ ë³µì‚¬í•˜ì—¬ ì—¬ê¸° íŒŒì¼ì— ë¶™ì—¬ë„£ê³ , Replitì˜ Database shell ë˜ëŠ” ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.

11) ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸(package.json)

{
  "scripts": { "start": "node index.js", "dev": "nodemon index.js" }
}

Replit Run ë²„íŠ¼ ë˜ëŠ” npm run devë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.

12) í—¬ìŠ¤ì²´í¬ ë° ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸

ë¸Œë¼ìš°ì €ì—ì„œ https://<your-repl>.repl.co/healthz â†’ ok ë³´ì´ë©´ ì„±ê³µ

https://<your-repl>.repl.co/ â†’ Google ë¡œê·¸ì¸ â†’ /api/me JSON í™•ì¸

13) ë‹¤ìŒìœ¼ë¡œ ë¶™ì¼ ê²ƒ(í˜ì´ì¦ˆ2)

í…œí”Œë¦¿ API: GET /api/templates, POST /api/templates/apply

ìº”ë²„ìŠ¤ ìƒíƒœ ì €ì¥: POST /api/canvas/:id/state (flow_json ì €ì¥)

OpenAI í”¼ë“œë°±: POST /api/canvas/:id/feedback (ìºì‹œ ê²€ì‚¬ í›„ í˜¸ì¶œ)

ìì‚° ì¸ì œìŠ¤íŠ¸: POST /api/assets (pdf/url) â†’ ingest_jobs í ì²˜ë¦¬

ì•„ì´ì½˜/ë…¸ë“œ íŒ¨ë„: node_types/node_instances/node_contents/node_metrics ì—°ê²°

14) íŠ¸ëŸ¬ë¸”ìŠˆíŒ…(ìì£¼ ë§‰íˆëŠ” í¬ì¸íŠ¸)

OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ë¶ˆì¼ì¹˜: Google Cloud Consoleì— ì •í™•íˆ ë“±ë¡(https/ë„ë©”ì¸ í¬í•¨)

DB ì—°ê²° ì‹¤íŒ¨: DATABASE_URL í™•ì¸, VPC/IP ì œí•œ í•´ì œ

OpenAI 401: OPENAI_API_KEY ëˆ„ë½/ê¶Œí•œ ë¬¸ì œ

íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜: multer íŒŒì¼ í¬ê¸° ì œí•œ ëŠ˜ë¦¬ê¸°(ì´ˆê¸° 5~10MB ê¶Œì¥)

ì‹œê°„ëŒ€: TZ_DEFAULT=Asia/Seoulë¡œ ë¡œê·¸/ìŠ¤ì¼€ì¤„ ì¼ì¹˜ í™•ì¸

ì—¬ê¸°ê¹Œì§€ ì™„ë£Œë˜ë©´, ìº”ë²„ìŠ¤ ë³¸ë¬¸ ìƒë‹¨ì˜ API/DDL ëª…ì„¸ì™€ 1:1 ë§¤ì¹­ë©ë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ì—ì„œ React Flow UIì™€ í…œí”Œë¦¿ ê°¤ëŸ¬ë¦¬ë¥¼ ì–¹ìœ¼ë©´ ì™„ì „í•œ MVPê°€ ë©ë‹ˆë‹¤.



ğŸ“¦ í…œí”Œë¦¿ 3ì¢… â€” JSON ë³„ì²¨ (Replit ê°€ì ¸ì˜¤ê¸°ìš©)

ì•„ë˜ JSONì„ ê°ê° íŒŒì¼ë¡œ ì €ì¥í•˜ì„¸ìš”:/templates/tpl_lead_basic_v1.json, /templates/tpl_checkout_basic_v1.json, /templates/tpl_subscription_basic_v1.json

1) tpl_lead_basic_v1.json

{
  "id": "tpl_lead_basic_v1",
  "name": "ë¦¬ë“œ ìˆ˜ì§‘ ë² ì´ì§",
  "version": 1,
  "category": "lead_capture",
  "tags": ["lead", "creator", "email"],
  "parameters": {
    "brand_name": "",
    "lead_magnet_title": "",
    "email_steps": 3
  },
  "best_practices": [
    "íˆì–´ë¡œ ì„¹ì…˜ì— ëª…í™•í•œ One-liner",
    "í¼ í•„ë“œëŠ” 3ê°œ ì´í•˜",
    "ì›°ì»´ ì´ë©”ì¼ì€ 24h/72h/120h ê°„ê²©"
  ],
  "flow_json": {
    "nodes": [
      {"id":"n-landing","type":"landing","data":{"title":"{{brand_name}} â€” ë¬´ë£Œ ë¦¬ì†ŒìŠ¤","oneLiner":"{{lead_magnet_title}}","cta":"ë‹¤ìš´ë¡œë“œ"},"position":{"x":0,"y":0}},
      {"id":"n-form","type":"form","data":{"fields":["email","name"],"policy":true},"position":{"x":0,"y":160}},
      {"id":"n-email1","type":"email","data":{"subject":"ìë£Œ ì „ë‹¬","preview":"ë‹¤ìš´ë¡œë“œ ë§í¬ ì•ˆë‚´","body_md":"ì•ˆë…•í•˜ì„¸ìš”, {{brand_name}} ì…ë‹ˆë‹¤. ìš”ì²­í•˜ì‹  ë¦¬ì†ŒìŠ¤ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.","cta":"ì—´ëŒ"},"position":{"x":0,"y":320}},
      {"id":"n-email2","type":"email","data":{"subject":"ë¬¸ì œ-í•´ê²° ì œì•ˆ","preview":"í•µì‹¬ í˜œíƒ ìš”ì•½","body_md":"ë‹¹ì‹ ì˜ ìƒí™©ì— ë§ì¶˜ ì†”ë£¨ì…˜ì„ ì†Œê°œí•©ë‹ˆë‹¤.","cta":"ìƒì„¸ ë³´ê¸°"},"position":{"x":0,"y":480}}
    ],
    "edges": [
      {"id":"e1","source":"n-landing","target":"n-form"},
      {"id":"e2","source":"n-form","target":"n-email1"},
      {"id":"e3","source":"n-email1","target":"n-email2"}
    ]
  }
}

2) tpl_checkout_basic_v1.json

{
  "id": "tpl_checkout_basic_v1",
  "name": "ì²´í¬ì•„ì›ƒ ë² ì´ì§",
  "version": 1,
  "category": "checkout",
  "tags": ["purchase", "stripe", "offer"],
  "parameters": {
    "brand_name": "",
    "offer_title": "",
    "price_label": "$99"
  },
  "best_practices": [
    "ëœë”© ì²« í™”ë©´ì— ê°€ì‹œì ì¸ CTA",
    "ê°€ê²©/ë³´ì¦/ë¦¬ìŠ¤í¬ ì—­ì „ ë¬¸êµ¬ í¬í•¨",
    "ì¥ë°”êµ¬ë‹ˆ ì´íƒˆ ë¦¬ë§ˆì¸ë” ì„¤ì •"
  ],
  "flow_json": {
    "nodes": [
      {"id":"n-landing","type":"landing","data":{"title":"{{brand_name}} â€” {{offer_title}}","oneLiner":"í•µì‹¬ ê°€ì¹˜ ì œì•ˆ","cta":"êµ¬ë§¤í•˜ê¸°"},"position":{"x":0,"y":0}},
      {"id":"n-product","type":"product","data":{"name":"ë©”ì¸ ì˜¤í¼","price":"{{price_label}}"},"position":{"x":0,"y":160}},
      {"id":"n-checkout","type":"checkout","data":{"provider":"stripe"},"position":{"x":0,"y":320}},
      {"id":"n-thanks","type":"thankyou","data":{"msg":"êµ¬ë§¤ ê°ì‚¬í•©ë‹ˆë‹¤!"},"position":{"x":0,"y":480}},
      {"id":"n-abemail","type":"email","data":{"subject":"ì¥ë°”êµ¬ë‹ˆê°€ ë‚¨ì•„ìˆì–´ìš”","preview":"1ë¶„ì´ë©´ ê²°ì œ ì™„ë£Œ","body_md":"êµ¬ë§¤ë¥¼ ë§ˆì¹˜ì§€ ì•Šìœ¼ì…¨ë„¤ìš”. ì§€ê¸ˆ ì´ì–´ì„œ ì™„ë£Œí•´ ë³´ì„¸ìš”.","cta":"ê²°ì œ ì™„ë£Œí•˜ê¸°"},"position":{"x":240,"y":320}}
    ],
    "edges": [
      {"id":"e1","source":"n-landing","target":"n-product"},
      {"id":"e2","source":"n-product","target":"n-checkout"},
      {"id":"e3","source":"n-checkout","target":"n-thanks"},
      {"id":"e4","source":"n-product","target":"n-abemail","label":"ì´íƒˆ"}
    ]
  }
}

3) tpl_subscription_basic_v1.json

{
  "id": "tpl_subscription_basic_v1",
  "name": "êµ¬ë… ë² ì´ì§",
  "version": 1,
  "category": "subscription",
  "tags": ["saas", "membership", "stripe"],
  "parameters": {
    "brand_name": "",
    "trial_label": "7ì¼ ì²´í—˜",
    "billing_cycle": "monthly"
  },
  "best_practices": [
    "ì²´í—˜â†’ìœ ë£Œ ì „í™˜ íë¦„ì„ ë¶„ëª…íˆ ì•ˆë‚´",
    "ì˜¨ë³´ë”© ì´ë©”ì¼ 3ë‹¨ê³„ êµ¬ì„±",
    "ê°±ì‹ /ë§Œë£Œ ì•Œë¦¼ ë¯¸ë¦¬ ì„¤ì •"
  ],
  "flow_json": {
    "nodes": [
      {"id":"n-landing","type":"landing","data":{"title":"{{brand_name}} êµ¬ë…","oneLiner":"ì§€ê¸ˆ ì‹œì‘í•˜ê³  í˜œíƒ ë°›ê¸°","cta":"ì²´í—˜ ì‹œì‘"},"position":{"x":0,"y":0}},
      {"id":"n-trial","type":"form","data":{"fields":["email"],"label":"{{trial_label}}"},"position":{"x":0,"y":160}},
      {"id":"n-onboard","type":"email","data":{"subject":"ì˜¨ë³´ë”© 1ì¼ì°¨","preview":"ì²« ì„¤ì • ê°€ì´ë“œ","body_md":"ê°€ì¥ ë¨¼ì € í•´ì•¼ í•  ì„¤ì •ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.","cta":"ì²« ì„¤ì •í•˜ê¸°"},"position":{"x":0,"y":320}},
      {"id":"n-billing","type":"subscription","data":{"provider":"stripe","plan":"{{billing_cycle}}"},"position":{"x":0,"y":480}},
      {"id":"n-renew","type":"email","data":{"subject":"ê°±ì‹  ì•Œë¦¼","preview":"ìë™ ê°±ì‹  ì˜ˆì •","body_md":"ë‹¤ìŒ ê²°ì œ ì „ í™•ì¸í•˜ì„¸ìš”.","cta":"ê³„ì • ê´€ë¦¬"},"position":{"x":0,"y":640}}
    ],
    "edges": [
      {"id":"e1","source":"n-landing","target":"n-trial"},
      {"id":"e2","source":"n-trial","target":"n-onboard"},
      {"id":"e3","source":"n-onboard","target":"n-billing"},
      {"id":"e4","source":"n-billing","target":"n-renew"}
    ]
  }
}

ì ìš© ë°©ë²•: íŒŒì¼ ì €ì¥ â†’ POST /api/templatesë¡œ ë“±ë¡í•˜ê±°ë‚˜, ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì˜ "í…œí”Œë¦¿ ì—…ë¡œë“œ"ì—ì„œ JSON ì—…ë¡œë“œ í›„ Apply ë²„íŠ¼ìœ¼ë¡œ í˜„ ìº”ë²„ìŠ¤ì— fork ì ìš©í•˜ì‹­ì‹œì˜¤.

